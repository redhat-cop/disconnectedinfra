---
- name: Create template
  template:
    src: esxi_template.tf.j2
    dest: "{{ project_path }}/esxi_template.tf"

- name: Terraform initialize
  ansible.builtin.command:
  args:
    chdir: "{{ project_path }}"
    argv:
    - terraform
    - init
  register: terraform_init
  changed_when: terraform_init.rc != 0
  failed_when: terraform_init.rc >= 2

- name: Deploy system
  ansible.builtin.command:
  args:
    chdir: "{{ project_path }}"
    argv:
    - terraform
    - "{{ terraform_state }}"
    - -auto-approve
  register: terraform_result
  changed_when: terraform_result.rc != 0
  failed_when: terraform_result.rc >= 2
  environment:
    TF_VAR_root_password: "{{ root_password }}"
